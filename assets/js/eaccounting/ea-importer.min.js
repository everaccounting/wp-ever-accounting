jQuery(function(o){o.eaccounting_importer=function(e,t){this.defaults={},this.form=e,this.$form=o(e),this.$top=o(".ea-importer-top",this.$form),this.$bottom=o(".ea-importer-bottom",this.$form),this.options=o.extend(this.defaults,t),this.action="eaccounting_do_ajax_import",this.nonce=this.$form.data("nonce"),this.type=this.$form.data("type"),this.sample={},this.mapping={},this.file="";var a=this;return this.submit=function(e){e.preventDefault(),a.$form.find(".ea-batch-notice").remove();var t=o('input[type="submit"]',a.$top),i=o('input[type="file"]',a.$top);if(t.hasClass("disabled"))return!1;if(a.$form.hasClass("mapped"))return a.mapping=a.$form.serializeAssoc().mapping,a.$form.append('<div class="ea-batch-notice"><div class="ea-batch-progress"><div></div></div></div>'),a.$form.find('input[type="submit"]').attr("disabled","disabled"),a.$form.find(".ea-importer-map-column").attr("disabled","disabled"),a.process_step(0),!1;e=new FormData;return e.append("upload",i[0].files[0]),e.append("action",a.action),e.append("nonce",a.nonce),e.append("type",a.type),e.append("step","upload"),t.addClass("disabled"),i.attr("disabled","disabled"),t.closest("p").append('<span class="spinner is-active"></span>'),a.$form.find(".ea-importer-map-column").attr("disabled","disabled"),window.wp.ajax.send({type:"POST",data:e,dataType:"json",cache:!1,contentType:!1,processData:!1,success:function(e){t.find(".spinner").remove(),a.$form.addClass("mapped"),t.removeClass("disabled"),a.sample=e.sample,a.file=e.file,a.$form.find(".ea-importer-map-column").removeAttr("disabled"),a.$form.trigger("upload_complete",[e])},error:function(e){a.$form.find(".spinner").remove(),t.removeClass("disabled"),i.removeAttr("disabled"),a.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+e.message+"</p></div></div>")}}),!1},this.process_step=function(e){var t=a.$form.find('input[type="submit"]');console.log({nonce:a.nonce,type:a.type,position:e,file:a.file,mapping:a.mapping}),window.wp.ajax.send(a.action,{data:{nonce:a.nonce,type:a.type,position:e,file:a.file,mapping:a.mapping},success:function(e){if("done"===e.position)return t.remove(),a.$form.find(".ea-batch-notice").remove(),a.$form.append('<div class="ea-batch-notice"><div class="updated success"><p>'+e.message+"</p></div></div>"),!1;a.$form.find(".ea-batch-progress div").animate({width:e.percentage+"%"},50,function(){}),a.process_step(parseInt(e.position,10))},error:function(e){t.removeAttr("disabled"),a.$form.find(".ea-batch-notice").remove(),a.$form.find(".ea-importer-map-column").removeAttr("disabled"),e.message&&a.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+e.message+"</p></div></div>"),console.warn(e)}})},this.init_mapping=function(e,i){if(o.isEmptyObject(i))return a.$form.find(".ea-batch-notice").remove(),a.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+eaccounting_importer_i10n.uploaded_file_not_found+"</p></div></div>"),!1;a.$top.hide(),a.$bottom.slideDown();var t=o(".ea-importer-map-column",a.$bottom),n=[];o.each(t,function(){var e=o(this),a=o(this).attr("name"),t=o(this).closest("tr");-1!==o.inArray(a.replace("mapping","").replace(/[\[\]\]]/g,""),i.required)&&(t.find("td").eq(0).append(" <strong>"+eaccounting_importer_i10n.required+"</strong>"),e.attr("required","required")),o.each(i.headers,function(e,t){var i=t.toLowerCase().replace(/ /g,"_").replace(/[""]/g,""),i=new RegExp("\\["+i+"\\]");a.length&&a.match(i)?n+='<option value="'+t+'" selected="selected">'+t+"</option>":n+='<option value="'+t+'">'+t+"</option>"}),o(this).append(n).trigger("change"),n=""})},this.handle_preview=function(){var e=o(this).prop("selectedIndex");e&&!1!==a.sample[e-1]?o(this).parent().next().html(a.sample[e-1]):o(this).parent().next().html(eaccounting_importer_i10n.select_field_to_preview)},this.init=function(){this.$form.on("submit",this.submit).on("upload_complete",a.$form,this.init_mapping).on("change",".ea-importer-map-column",this.handle_preview)},this.init(),this},o.fn.eaccounting_importer=function(e){return this.each(function(){new o.eaccounting_importer(this,e)})},o(".ea-importer").eaccounting_importer()});