jQuery(function(t){t.fn.eaccounting_form=function(e){return this.each(function(){new t.eaccounting_form(this,e)})},t.eaccounting_form=function(e,n){this.form=e,this.$form=t(e),this.options=n;var o=this;return this.$account_select=t("#account_id, #from_account_id",this.$form),this.$currency_select=t("#currency_code",this.$form),this.$customer_select=t("#customer_id",this.$form),this.$vendor_select=t("#vendor_id",this.$form),this.$category_select=t("#category_id",this.$form),this.$amount_input=t("#amount, #opening_balance",this.$form),this.$currency_code_select=t("#code, #currency_code",this.$form),this.$uploader=t('[type="file"]',this.$form),this.$file_value=t(".ea-file-input",this.$form),this.$file_preview=t(".ea-file",this.$el),this.block=function(){this.$form.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},this.unblock=function(){this.$form.unblock()},this.handle_error=function(e){console.warn(e),o.unblock(),t.eaccounting_notice(e,"error")},this.mask_input=function(e){o.$amount_input.inputmask("decimal",{alias:"numeric",groupSeparator:e.thousand_separator,autoGroup:!0,digits:e.precision,radixPoint:e.decimal_separator,digitsOptional:!1,allowMinus:!1,prefix:e.symbol,placeholder:"0.000",rightAlign:0})},this.get_account=function(e,n){wp.ajax.send("eaccounting_get_account",{data:{id:e,_wpnonce:eaccounting_form_i10n.nonce.get_account},success:n,error:o.handle_error})},this.get_currency=function(e,n){console.log("eaccounting_get_currency"),wp.ajax.send("eaccounting_get_currency",{data:{code:e,_wpnonce:eaccounting_form_i10n.nonce.get_currency},success:n,error:o.handle_error})},this.$account_select.on("change",function(){if(!o.$amount_input.length)return!1;var e=parseInt(o.$account_select.val(),10);if(!e)return!1;o.block();o.get_account(e,function(e){e=e.currency_code,o.get_currency(e,function(e){o.mask_input(e),o.unblock()})})}),this.$currency_select.on("change",function(){if(!o.$amount_input.length)return!1;var e=o.$currency_select.val();if(!e)return!1;o.block(),o.get_currency(e,function(e){o.mask_input(e),o.unblock()})}),this.$currency_code_select.on("change",function(){var e=o.$currency_code_select.val();if(!e)return!1;try{var n=eaccounting_form_i10n.global_currencies[e];t("#precision",o.$form).val(n.precision).change(),t("#position",o.$form).val(n.position).change(),t("#symbol",o.$form).val(n.symbol).change(),t("#decimal_separator",o.$form).val(n.decimal_separator).change(),t("#thousand_separator",o.$form).val(n.thousand_separator).change()}catch(c){console.warn(c.message)}}),o.$uploader.on("change",function(e){var n=new FormData;n.append("nonce",o.$uploader.data("nonce")),n.append("upload",o.$uploader[0].files[0]),n.append("limit",o.$uploader.data("limit")),n.append("action","eaccounting_upload_files"),o.block(),window.wp.ajax.send({type:"POST",data:n,dataType:"json",cache:!1,contentType:!1,processData:!1,success:function(e){o.unblock(),o.$file_value.val(e.url),o.$file_preview.find(".ea-file-link").text(e.name).attr("href",e.url),o.$file_preview.show(),o.$uploader.hide()},error:function(e){o.handle_error(e)}})}),o.$form.find(".ea-file-delete").on("click",function(e){e.preventDefault(),o.$file_value.val(""),o.$file_preview.find(".ea-file-link").text("").attr("href",""),o.$file_preview.hide(),o.$uploader.show()}),this.$form.on("submit",function(e){e.preventDefault(),o.block(),wp.ajax.send({data:o.$form.serializeAssoc(),success:function(e){o.unblock(),t.eaccounting_notice(e,"success"),t.eaccounting_redirect(e)},error:function(e){console.warn(e),o.unblock(),t.eaccounting_notice(e.message,"error")}})}),this.init=function(){o.$account_select.length&&o.$account_select.trigger("change"),o.$currency_select.length&&o.$currency_select.trigger("change")},this.init(),this},t(document).ready(function(){t(".ea-ajax-form").eaccounting_form()});var n={init:function(){t("#ea-tax-form").on("change keyup",'input[name="rate"]',this.input_tax_rate).on("submit",this.submit),t(document).on("ready",function(){t('#ea-tax-form input[name="rate"]').trigger("change")})},block:function(){t("#ea-tax-form").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){t("#ea-tax-form").unblock()},input_tax_rate:function(e){e.target.value=e.target.value.replace(/[^0-9.]/g,"")},submit:function(e){e.preventDefault(),n.block(),wp.ajax.send({data:t("#ea-tax-form").serializeAssoc(),success:function(e){n.unblock(),t.eaccounting_notice(e,"success"),t.eaccounting_redirect(e)},error:function(e){console.warn(e),n.unblock(),t.eaccounting_notice(e.message,"error")}})}},c={init:function(){t("#ea-revenue-form").on("change","#account_id",this.update_amount_input).on("submit",this.submit),t(document).on("ready",function(){t("#ea-revenue-form #account_id").trigger("change")})},block:function(){t("#ea-revenue-form").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){t("#ea-revenue-form").unblock()},update_amount_input:function(e){e=parseInt(e.target.value,10);if(!e)return!1;c.block();var n=t("#ea-revenue-form #amount");wp.ajax.send("eaccounting_get_account_currency",{data:{account_id:e,_wpnonce:eaccounting_form_i10n.nonce.get_currency},success:function(e){e=e,n.inputmask("decimal",{alias:"numeric",groupSeparator:e.thousand_separator,autoGroup:!0,digits:e.precision,radixPoint:e.decimal_separator,digitsOptional:!1,allowMinus:!1,prefix:e.symbol,placeholder:"0.000",rightAlign:0}),c.unblock()},error:function(e){console.warn(e),c.unblock(),t.eaccounting_notice(e.message,"error")}})},submit:function(e){e.preventDefault(),c.block(),wp.ajax.send({data:t("#ea-tax-form").serializeAssoc(),success:function(e){c.unblock(),t.eaccounting_notice(e,"success"),t.eaccounting_redirect(e)},error:function(e){console.warn(e),c.unblock(),t.eaccounting_notice(e.message,"error")}})}},o={init:function(){t("#ea-category-form").on("submit",this.submit)},block:function(){t("#ea-category-form").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){t("#ea-category-form").unblock()},submit:function(e){e.preventDefault(),o.block(),wp.ajax.send({data:t("#ea-category-form").serializeAssoc(),success:function(e){o.unblock(),t.eaccounting_notice(e,"success"),t.eaccounting_redirect(e)},error:function(e){console.warn(e),n.unblock(),t.eaccounting_notice(e.message,"error")}})}};n.init(),c.init(),o.init()});