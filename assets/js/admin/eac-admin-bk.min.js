!function(a,o){"use strict";var t={init:function(){a(o).on("init-select2",this.init_select2).on("init-datepicker",this.init_datepicker).on("init-price-input",this.init_price_input).on("init-tooltip",this.init_tooltip).on("init-drawer",this.init_drawer).on("click",".del",this.handle_delete).on("submit",".eac-form",this.form_submit).on("click",".eac-dropdown__button",this.toggle_dropdown).on("eac_drawer_ready",this.init_drawer).on("change",'.eac-form [name="is_taxable"]',this.toggle_tax_fields).trigger("init-select2").trigger("init-datepicker").trigger("init-price-input").trigger("init-tooltip"),a('.eac-form [name="taxable"]').trigger("change"),a(".eac-document__form").on("change",".eac-select-customer",this.change_customer_user)},init_select2:function(){a(".eac-select2").eac_select2(),a(".ever-accounting select[data-eac-select2]").eac_select2({ajax:{delay:250,url:eac_admin_vars.ajax_url,method:"POST",dataType:"json",data(e){return{action:"eac_json_search",args:a(this).data("query-args"),type:a(this).data("eac-select2"),_wpnonce:eac_admin_vars.json_search,term:e.term,page:e.page}},processResults(e,t){return t.page=t.page||1,e}}})},init_datepicker:function(){a(".eac-field-date").datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,yearRange:"-100:+0"})},init_price_input:function(){var n=eac_admin_vars.base_currency;a(".eac-form").each(function(){var e=a(this),t=e.find('[name="currency_code"]'),i=t.val()||n,i=eac_admin_vars.currencies[i];e.find(".eac-field-money").inputmask("decimal",{alias:"numeric",groupSeparator:i.thousand_sep,autoGroup:!0,digits:i.precision,radixPoint:i.decimal_sep,digitsOptional:!1,allowMinus:!0,prefix:"before"===i.position?i.symbol:"",suffix:"after"===i.position?i.symbol:""}),t.length&&t.on("change",function(){a(o).trigger("init-price-input")})})},init_tooltip:function(){a(".eac-tooltip").tooltip({tooltipClass:"eac-ui-tooltip",position:{my:"center top",at:"center bottom+10",collision:"flipfit"},hide:{duration:200},show:{duration:200}})},toggle_dropdown:function(e){e.preventDefault(),e.stopPropagation(),a(this).closest(".eac-dropdown").toggleClass("is--open"),a(o).on("click",function(){a(".eac-dropdown").removeClass("is--open")})},init_drawer:function(){a(o).trigger("init-select2").trigger("init-datepicker").trigger("init-price-input").trigger("init-tooltip")},toggle_tax_fields:function(){var e=a(this),t=e.closest(".eac-form").find(".eac-field--tax_ids");"yes"===e.val()?t.show():t.hide()},handle_delete:function(){if(!confirm(eac_admin_vars.i18n.delete_confirmation))return e.preventDefault(),!1},form_submit:function(e){e.preventDefault();var t=a(this),e=t.serializeAssoc(),i=a('[form="'+t.attr("id")+'"]');i.is(":disabled")||(i.attr("disabled","disabled"),t.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.post(eac_admin_vars.ajax_url,e,function(e){e.success&&(t.closest(".eac-drawer").length?t.closest(".eac-drawer").data("eac_drawer").close():a.eac_redirect(e))}).always(function(e){t.unblock(),i.removeAttr("disabled"),a.eac_notification(e)}))}},i={init:function(){this.bindEvents()},bindEvents:function(){a("form.eac-document").on("click",".add-line-item",this.toggle_new_line_item).on("change",".select-new-item",this.select_new_line_item).on("click",".remove-line-item",this.remove_line_item).on("block",this.block_form).on("unblock",this.unblock_form).on("updated",this.update_form).on("submit",this.form_submit)},toggle_new_line_item:function(e){e.preventDefault(),a(this).closest("form").find(".eac-document__items-new-line").toggle()},select_new_line_item:function(e){e.preventDefault();var e=a(this),t=e.closest("form"),e=e.val(),i=t.find(".calculate-totals");e&&(t.append('<input type="hidden" name="items[][product_id]" value="'+e+'">'),i.trigger("click"))},remove_line_item:function(e){e.preventDefault();var e=a(this),t=e.closest("form");e.closest(".eac-document__items-line").remove(),t.find(".calculate-totals").trigger("click")},block_form:function(){var e=a(this),t=e.find(".calculate-totals"),i=a('[form="'+e.attr("id")+'"]');t.attr("disabled","disabled"),i.attr("disabled","disabled"),e.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock_form:function(){var e=a(this),t=e.find(".calculate-totals");a('[form="'+e.attr("id")+'"]').removeAttr("disabled"),t.removeAttr("disabled"),e.unblock()},update_form:function(){a(o).trigger("init-select2").trigger("init-datepicker").trigger("init-price-input").trigger("init-tooltip")},form_submit:function(e){e.preventDefault();var t=a(this),i=[],n=(t.find("input, select, textarea").each(function(){var e=a(this).attr("name"),t=a(this).val();e&&i.push({name:e,value:t})}),a('[form="'+t.attr("id")+'"]'));n.is(":disabled")||(n.trigger("block"),t.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),a.post(eac_admin_vars.ajax_url,i,function(e){e.success&&a.eac_redirect(e)}).always(function(e){t.trigger("unblock"),n.removeAttr("disabled"),a.eac_notification(e)}))}},n={init:function(){this.bindEvents()},bindEvents:function(){a("form.eac-invoice-form").on("click",".calculate-totals",this.calculate_totals)},calculate_totals:function(e){console.log("calculate_totals"),e.preventDefault();var n=a(this).closest("form"),i=[{name:"action",value:"eac_calculate_invoice"}];if(n.find("input, select, textarea").each(function(){var e=a(this).attr("name"),t=a(this).val();e&&"action"!==e&&i.push({name:e,value:t})}),a('[form="'+n.attr("id")+'"]').is(":disabled"))return!1;n.trigger("block"),n.load(eac_admin_vars.ajax_url,i,function(e,t,i){"error"===t&&a.eac_notification({success:!1,message:i.statusText}),n.trigger("updated"),n.trigger("unblock")})}};a(o).ready(function(){t.init(),i.init(),n.init()})}(jQuery,(window,document));