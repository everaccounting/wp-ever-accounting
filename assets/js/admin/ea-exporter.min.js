jQuery( function ( i ) {
	( i.fn.eaccounting_exporter = function ( t ) {
		return this.each( function () {
			new i.eaccounting_exporter( this, t );
		} );
	} ),
		( i.eaccounting_exporter = function ( t, e ) {
			( this.defaults = {} ),
				( this.form = t ),
				( this.$form = i( t ) ),
				( this.$submit_btn = i( 'input[type="submit"]', this.$form ) ),
				( this.options = i.extend( this.defaults, e ) ),
				( this.action = 'eaccounting_do_ajax_export' ),
				( this.nonce = this.$form.data( 'nonce' ) ),
				( this.type = this.$form.data( 'type' ) );
			var s = this;
			return (
				( this.submit = function ( t ) {
					if (
						( t.preventDefault(),
						s.$submit_btn.hasClass( 'disabled' ) )
					)
						return ! 1;
					s.$submit_btn.addClass( 'disabled' ),
						s.reset(),
						s.$submit_btn
							.parent( 'p' )
							.append(
								'<span class="spinner is-active"></span>'
							),
						s.$form.append(
							'<div class="ea-batch-notice"><div class="ea-batch-progress"><div></div></div></div>'
						),
						s.process_step( 1 );
				} ),
				( this.process_step = function ( t ) {
					window.wp.ajax.send( s.action, {
						data: { nonce: s.nonce, type: s.type, step: t },
						success: function ( t ) {
							if ( 'done' === t.step )
								return (
									s.reset(),
									s.$form.append(
										'<div class="ea-batch-notice"><div class="updated success"><p>' +
											t.message +
											'</p></div></div>'
									),
									( window.location = t.url ),
									! 1
								);
							s.$form
								.find( '.ea-batch-progress div' )
								.animate(
									{ width: t.percentage + '%' },
									50,
									function () {}
								),
								s.process_step( parseInt( t.step, 10 ) );
						},
						error: function ( t ) {
							s.reset(),
								t.message &&
									s.$form.append(
										'<div class="ea-batch-notice"><div class="updated error"><p>' +
											t.message +
											'</p></div></div>'
									),
								console.warn( t );
						},
					} );
				} ),
				( this.reset = function () {
					i( '.ea-batch-notice', s.$form ).remove(),
						s.$submit_btn.removeClass( 'disabled' ),
						i( '.spinner', s.$form ).remove();
				} ),
				( this.init = function () {
					this.$form.on( 'submit', this.submit );
				} ),
				this.init(),
				this
			);
		} ),
		i( '.ea-exporter' ).eaccounting_exporter();
} );
