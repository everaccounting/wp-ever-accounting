jQuery(function(r){r.eaccounting_importer=function(e,t){this.defaults={},this.form=e,this.$form=r(e),this.$top=r(".ea-importer-top",this.$form),this.$bottom=r(".ea-importer-bottom",this.$form),this.options=r.extend(this.defaults,t),this.action="eaccounting_do_ajax_import",this.nonce=this.$form.data("nonce"),this.type=this.$form.data("type"),this.sample={},this.mapping={},this.file="";var n=this;return this.submit=function(e){e.preventDefault(),n.$form.find(".ea-batch-notice").remove();var t=r('input[type="submit"]',n.$top),i=r('input[type="file"]',n.$top);if(t.hasClass("disabled"))return!1;if(n.$form.hasClass("mapped"))return n.mapping=n.$form.serializeAssoc().mapping,n.$form.append('<div class="ea-batch-notice"><div class="ea-batch-progress"><div></div></div></div>'),n.$form.find('input[type="submit"]').attr("disabled","disabled"),n.$form.find(".ea-importer-map-column").attr("disabled","disabled"),n.process_step(0),!1;var a=new FormData(n.form);return a.append("action",n.action),a.append("nonce",n.nonce),a.append("type",n.type),a.append("step","upload"),t.addClass("disabled"),i.attr("disabled","disabled"),t.closest("p").append('<span class="spinner is-active"></span>'),n.$form.find(".ea-importer-map-column").attr("disabled","disabled"),window.wp.ajax.send({type:"POST",data:a,dataType:"json",cache:!1,contentType:!1,processData:!1,success:function(e){t.find(".spinner").remove(),n.$form.addClass("mapped"),t.removeClass("disabled"),n.sample=e.sample,n.file=e.file,n.$form.find(".ea-importer-map-column").removeAttr("disabled"),n.$form.trigger("upload_complete",[e])},error:function(e){n.$form.find(".spinner").remove(),t.removeClass("disabled"),i.removeAttr("disabled"),n.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+e.message+"</p></div></div>")}}),!1},this.process_step=function(e){var t=n.$form.find('input[type="submit"]');window.wp.ajax.send(n.action,{data:{nonce:n.nonce,type:n.type,position:e,file:n.file,mapping:n.mapping},success:function(e){if("done"===e.position)return t.remove(),n.$form.find(".ea-batch-notice").remove(),n.$form.append('<div class="ea-batch-notice"><div class="updated success"><p>'+e.message+"</p></div></div>"),!1;n.$form.find(".ea-batch-progress div").animate({width:e.percentage+"%"},50,function(){}),n.process_step(parseInt(e.position,10))},error:function(e){t.removeAttr("disabled"),n.$form.find(".ea-batch-notice").remove(),n.$form.find(".ea-importer-map-column").removeAttr("disabled"),e.message&&n.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+e.message+"</p></div></div>"),console.warn(e)}})},this.init_mapping=function(e,i){if(r.isEmptyObject(i))return n.$form.find(".ea-batch-notice").remove(),n.$form.append('<div class="ea-batch-notice"><div class="updated error"><p>'+eaccounting_importer_i10n.uploaded_file_not_found+"</p></div></div>"),!1;n.$top.hide(),n.$bottom.slideDown();var t=r(".ea-importer-map-column",n.$bottom),o=[];r.each(t,function(){var e=r(this),n=r(this).attr("name"),t=r(this).closest("tr");-1!==r.inArray(n.replace("mapping","").replace(/[\[\]\]]/g,""),i.required)&&(t.find("td").eq(0).append(" <strong>"+eaccounting_importer_i10n.required+"</strong>"),e.attr("required","required")),r.each(i.headers,function(e,t){var i=t.toLowerCase().replace(/ /g,"_"),a=new RegExp("\\["+i+"\\]");n.length&&n.match(a)?o+='<option value="'+t+'" selected="selected">'+t+"</option>":o+='<option value="'+t+'">'+t+"</option>"}),r(this).append(o).trigger("change"),o=""})},this.handle_preview=function(){var e=r(this).prop("selectedIndex");e&&!1!==n.sample[e-1]?r(this).parent().next().html(n.sample[e-1]):r(this).parent().next().html(eaccounting_importer_i10n.select_field_to_preview)},this.init=function(){this.$form.on("submit",this.submit).on("upload_complete",n.$form,this.init_mapping).on("change",".ea-importer-map-column",this.handle_preview)},this.init(),this},r.fn.eaccounting_importer=function(e){return this.each(function(){new r.eaccounting_importer(this,e)})},r(".ea-importer").eaccounting_importer()});